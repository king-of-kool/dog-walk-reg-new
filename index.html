<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Narberth Dog Walk Status</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="sideMenu">
    <h2><i class="fas fa-paw"></i> Narberth Dog Walks</h2>
    <a href="https://dog-walk-reg.netlify.app" class="active" aria-current="page"><i class="fas fa-home"></i> Home</a>
    <a href="#submit-status"><i class="fas fa-plus-circle"></i> Submit Status</a>
    <a href="#view-status"><i class="fas fa-list"></i> View Statuses</a>
    <a href="#map-view"><i class="fas fa-map-marked-alt"></i> Map View</a>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSdu2G3Sy30ToJL2rWNHo_mKKItRnvlRmcFv78pM2Y-q0e1jYQ/viewform?usp=header">Give Feedback!</a>
  </div>

  <!-- Hamburger Menu -->
  <div id="hamburgerMenu" aria-label="Toggle navigation menu">
    <div></div>
    <div></div>
    <div></div>
  </div>

  <div class="main-content">
    <h1><i class="fas fa-paw"></i> Narberth Dog Walk Status</h1>
    <p>Share your dog walking status with other owners in Narberth to help coordinate walks and avoid busy areas.</p>

    <!-- Map Container -->
    <div id="mapContainer"></div>

    <!-- Filter Controls -->
    <div class="filter-controls">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="walking">Walking</button>
      <button class="filter-btn" data-filter="not-walking">Not Walking</button>
      <button class="filter-btn" data-filter="planning">Planning to walk</button>
      <button class="filter-btn" data-filter="friendly">Friendly Dogs</button>
      <button class="filter-btn" data-filter="service">Service Dogs</button>
    </div>

    <form id="walkForm">
      <label class="form-full-width">
        Are you walking your dog?
        <select id="walkingStatus" required>
          <option value="yes">Yes, currently walking</option>
          <option value="no">No, not currently walking</option>
          <option value="planning">Planning to walk soon</option>
        </select>
      </label>

      <label class="form-full-width">
        Location in Narberth:
        <div class="map-controls">
          <input type="text" id="location" required maxlength="50" placeholder="E.g. Narberth Moor, Bloomfield Park" list="narberthLocations" />
          <datalist id="narberthLocations">
            <option value="Narberth Moor">
            <option value="Bloomfield Park">
            <option value="Narberth High Street">
            <option value="Narberth Castle">
            <option value="Narberth Playing Fields">
            <option value="Narberth Woods">
            <option value="Narberth Dog Park">
          </datalist>
          <button type="button" id="selectOnMapBtn" class="map-btn" aria-label="Select location on map"><i class="fas fa-map-marker-alt"></i> Select on Map</button>
        </div>
      </label>

      <div id="mapSelectionContainer"></div>

      <label>
        Walk Time:
        <input type="time" id="walkTime" required />
      </label>

      <label>
        Dog Status
        <select id="dogStatus" required>
          <option value="Friendly">Friendly with dogs and people</option>
          <option value="Friendly">Friendly with dogs</option>
          <option value="Friendly">Friendly with people</option>
          <option value="Nervous">Nervous/Shy</option>
          <option value="Not Friendly">Not friendly (please keep distance)</option>
          <option value="Service Dog">Service Dog (do not disturb)</option>
          <option value="In Training">In Training</option>
        </select>
      </label>

      <label>
        Safety Status
        <select id="safetyOptions" required>
          <option value="safe">Safe area</option>
          <option value="unsafe">Unsafe (recent incidents)</option>
          <option value="unknown">Unknown safety</option>
          <option value="busy">Very busy area</option>
        </select>
      </label>

      <label class="form-full-width">
        Other Notes (optional):
        <textarea id="otherNotes" maxlength="200" placeholder="E.g., 'We'll be wearing red bandanas', 'Avoid the north side of the Moor'"></textarea>
      </label>

      <button type="submit"><i class="fas fa-paper-plane"></i> Submit Status</button>
    </form>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="spinner"></div>

    <!-- Dark Mode Toggle -->
    <div class="toggle-container" aria-label="Dark mode toggle">
      <i class="fas fa-sun toggle-icon"></i>
      <input type="checkbox" id="toggleModeCheckbox" aria-label="Toggle dark mode">
      <label for="toggleModeCheckbox"></label>
      <i class="fas fa-moon toggle-icon"></i>
    </div>

    <h2><i class="fas fa-list-ul"></i> Current Dog Walk Statuses in Narberth</h2>
    <div id="statusList"></div>

    <div id="emptyState" class="text-center mt-20 hidden">
      <i class="fas fa-dog" style="font-size: 3rem; color: var(--primary-color);"></i>
      <h3>No walk statuses found in Narberth</h3>
      <p>Be the first to submit a dog walk status in our town!</p>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification" role="alert" aria-live="assertive">
    <i class="fas fa-check-circle"></i>
    <span>Status submitted successfully!</span>
  </div>

  <!-- Flash Message Modal -->
  <div id="flashModal" class="flash-modal" style="display:none;">
    <div class="flash-modal-content" id="flashModalContent">
      <div style="height:400px;overflow-y:auto;" id="flashModalScroll">
        <center>
          <h1 style="margin:0;">Welcome</h1>
          <h3 style="color: dimgrey;">Hi, I am Oliver, the lead developer for this site.</h3>
          <p></p>
          <h3 style="color: dimgray;">
            Welcome to our website! We are a dedicated team of three secondary school students who have worked tirelessly to create a platform that prioritizes the safety of you and your beloved dogs.<br>Our mission is to provide valuable resources and information to ensure a safer environment for all dog owners.<br>

          In our spare time, we have poured our hearts into this project, driven by our passion for animal welfare and community service. We believe that every dog deserves a safe and loving home, and we are committed to making a positive impact in the lives of dogs and their owners.

          Thank you for visiting our site, and we hope you find it helpful!
          </h3>
          <h3 style="color: dimgray;">Please use the site responsibly and report any issues to us.</h3>
        </center>
        <div style="height:300px;"></div>
      </div>
      <button id="flashModalOk" disabled>OK</button>
    </div>
  </div>

  <!-- Firebase SDK and App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onChildRemoved, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBJCH6BWXLubF_QXXuF23tP9RUUPqml3KU",
      authDomain: "walker-book.firebaseapp.com",
      databaseURL: "https://walker-book-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "walker-book",
      storageBucket: "walker-book.firebasestorage.app",
      messagingSenderId: "316163790375",
      appId: "1:316163790375:web:3e9fe6d56de5eb8486a002",
      measurementId: "G-E2B6F1Y2XS"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const statusListRef = query(ref(database, 'narberthDogWalkStatuses'), orderByChild('timestamp'));
    const refreshRef = ref(database, 'refresh');

    // DOM elements
    const statusListEl = document.getElementById('statusList');
    const emptyStateEl = document.getElementById('emptyState');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const mapContainer = document.getElementById('mapContainer');
    const mapSelectionContainer = document.getElementById('mapSelectionContainer');
    const selectOnMapBtn = document.getElementById('selectOnMapBtn');
    const locationInput = document.getElementById('location');
    const walkForm = document.getElementById('walkForm');

    // Map variables
    let map, selectionMap, geocoder, selectionMarker, autocomplete;
    let markers = [];
    let currentFilter = 'all';
    let isThrottled = false;

    // Narberth coordinates
    const NARBERTH_CENTER = { lat: 51.7978, lng: -4.7427 };
    const DEFAULT_ZOOM = 15;

    // Hamburger menu
    document.getElementById("hamburgerMenu").addEventListener("click", function() {
      document.getElementById("sideMenu").classList.toggle("open");
      this.classList.toggle("open");
    });

    // Refresh logic
    document.addEventListener('DOMContentLoaded', () => {
      checkForRefresh();
      initEventListeners();
      checkGeolocation();
      loadMapLibrary();
    });

    // Move dark mode logic to the top for consistency
    function applyDarkMode(isDark) {
      document.body.classList.toggle('dark-mode', isDark);
      localStorage.setItem('darkMode', isDark);
      // Update map styles if maps are loaded
      if (window.map) map.setOptions({ styles: getMapStyle() });
      if (window.selectionMap) selectionMap.setOptions({ styles: getMapStyle() });
      // Update toggle switch state
      document.getElementById('toggleModeCheckbox').checked = isDark;
    }

    // On load, apply dark mode from localStorage
    document.addEventListener('DOMContentLoaded', () => {
      const isDark = localStorage.getItem('darkMode') === 'true';
      applyDarkMode(isDark);
      checkForRefresh();
      initEventListeners();
      checkGeolocation();
      loadMapLibrary();
    });

    function checkForRefresh() {
      refreshRef.get().then((snapshot) => {
        if (snapshot.exists() && snapshot.val() === true) {
          window.location.reload();
        }
      }).catch((error) => {
        console.error("Error fetching refresh value:", error);
      });
    }

    function initEventListeners() {
      walkForm.addEventListener('submit', handleFormSubmit);
      document.getElementById('toggleModeCheckbox').addEventListener('change', (e) => {
        applyDarkMode(e.target.checked);
      });
      filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          filterButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          filterStatuses();
        });
      });
      selectOnMapBtn.addEventListener('click', showMapSelection);
      window.addEventListener('hashchange', handleHashChange);
      handleHashChange();
    }

    function handleHashChange() {
      const hash = window.location.hash;
      const sideMenuLinks = document.querySelectorAll('#sideMenu a');
      sideMenuLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === hash) {
          link.classList.add('active');
        }
      });
      if (hash === '#map-view') showMapView();
      else if (hash === '#submit-status') walkForm.scrollIntoView({ behavior: 'smooth' });
      else if (hash === '#view-status') document.querySelector('h2').scrollIntoView({ behavior: 'smooth' });
    }

    function showMapView() {
      mapContainer.style.display = 'block';
      statusListEl.style.display = 'none';
      if (typeof google !== 'undefined' && !map) initMainMap();
    }

    function showListView() {
      mapContainer.style.display = 'none';
      statusListEl.style.display = 'grid';
    }

    function loadMapLibrary() {
      if (typeof google === 'undefined') {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCTLsji9XOlgHK-YUPrQYSfLPB5NoerVWY&libraries=places&callback=initMaps`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
      }
    }

    window.initMaps = function() {
      initMainMap();
      initSelectionMap();
      initAutocomplete();
    };

    function initMainMap() {
      if (typeof google === 'undefined') return;
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
          const distance = getDistanceFromNarberth(userLocation);
          const center = distance < 20 ? userLocation : NARBERTH_CENTER;
          map = new google.maps.Map(mapContainer, { center, zoom: DEFAULT_ZOOM, styles: getMapStyle() });
          geocoder = new google.maps.Geocoder();
          addExistingMarkers();
        },
        () => {
          map = new google.maps.Map(mapContainer, { center: NARBERTH_CENTER, zoom: DEFAULT_ZOOM, styles: getMapStyle() });
          geocoder = new google.maps.Geocoder();
          addExistingMarkers();
        },
        { timeout: 10000, enableHighAccuracy: true }
      );
    }

    function getDistanceFromNarberth(location) {
      const R = 6371;
      const dLat = (location.lat - NARBERTH_CENTER.lat) * Math.PI / 180;
      const dLon = (location.lng - NARBERTH_CENTER.lng) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(NARBERTH_CENTER.lat * Math.PI / 180) *
        Math.cos(location.lat * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function initSelectionMap() {
      if (typeof google === 'undefined') return;
      selectionMap = new google.maps.Map(mapSelectionContainer, {
        center: NARBERTH_CENTER,
        zoom: DEFAULT_ZOOM,
        styles: getMapStyle()
      });
      selectionMap.addListener('click', (e) => {
        placeSelectionMarker(e.latLng);
        reverseGeocode(e.latLng);
      });
    }

    function initAutocomplete() {
      if (typeof google === 'undefined') return;
      const defaultBounds = {
        north: NARBERTH_CENTER.lat + 0.05,
        south: NARBERTH_CENTER.lat - 0.05,
        east: NARBERTH_CENTER.lng + 0.05,
        west: NARBERTH_CENTER.lng - 0.05
      };
      autocomplete = new google.maps.places.Autocomplete(locationInput, {
        bounds: defaultBounds,
        types: ['establishment', 'geocode'],
        fields: ['formatted_address', 'geometry']
      });
      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;
        if (selectionMap) {
          selectionMap.setCenter(place.geometry.location);
          selectionMap.setZoom(17);
          placeSelectionMarker(place.geometry.location);
        }
      });
    }

    function placeSelectionMarker(location) {
      if (selectionMarker) {
        selectionMarker.setPosition(location);
      } else {
        selectionMarker = new google.maps.Marker({
          position: location,
          map: selectionMap,
          draggable: true,
          title: "Selected Location in Narberth"
        });
        selectionMarker.addListener('dragend', () => {
          reverseGeocode(selectionMarker.getPosition());
        });
      }
    }

    function reverseGeocode(latLng) {
      if (!geocoder) return;
      geocoder.geocode({ location: latLng }, (results, status) => {
        if (status === 'OK' && results[0]) {
          const address = results[0].formatted_address;
          const simplifiedAddress = address.replace(/, UK$/, '').replace(/Narberth, Pembrokeshire/i, 'Narberth');
          locationInput.value = simplifiedAddress;
        }
      });
    }

    function showMapSelection() {
      mapSelectionContainer.style.display = 'block';
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
            if (selectionMap) {
              if (getDistanceFromNarberth(userLocation) < 20) selectionMap.setCenter(userLocation);
              else selectionMap.setCenter(NARBERTH_CENTER);
              selectionMap.setZoom(DEFAULT_ZOOM);
            }
          },
          () => {
            if (selectionMap) {
              selectionMap.setCenter(NARBERTH_CENTER);
              selectionMap.setZoom(DEFAULT_ZOOM);
            }
          },
          { timeout: 10000, enableHighAccuracy: true }
        );
      }
    }

    function getMapStyle() {
      return document.body.classList.contains('dark-mode') ? [
        { elementType: "geometry", stylers: [{ color: "#1e293b" }] },
        { elementType: "labels.text.stroke", stylers: [{ color: "#1e293b" }] },
        { elementType: "labels.text.fill", stylers: [{ color: "#9ca3af" }] },
        { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#93c5fd" }] },
        { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca3af" }] },
        { featureType: "administrative.province", elementType: "labels.text.fill", stylers: [{ color: "#93c5fd" }] },
        { featureType: "administrative.country", elementType: "labels.text.fill", stylers: [{ color: "#93c5fd" }] },
        { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] },
        { featureType: "poi.business", elementType: "labels", stylers: [{ visibility: "off" }] },
        { featureType: "poi.place_of_worship", elementType: "labels", stylers: [{ visibility: "off" }] },
        { featureType: "poi.school", elementType: "labels", stylers: [{ visibility: "off" }] },
        { featureType: "poi.medical", elementType: "labels", stylers: [{ visibility: "off" }] },
        { featureType: "poi.government", elementType: "labels", stylers: [{ visibility: "off" }] },
        { featureType: "poi.park", elementType: "labels", stylers: [{ visibility: "off" }] },
        { featureType: "transit", elementType: "labels", stylers: [{ visibility: "off" }] },
        { featureType: "water", elementType: "labels", stylers: [{ visibility: "off" }] },
        { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#bfdbfe" }] },
        { featureType: "road.highway", elementType: "labels", stylers: [{ visibility: "on" }] },
      ] : [];
    }

    function addMarker(statusData, statusId) {
      if (!map || !geocoder) return;
      geocoder.geocode({ address: statusData.location + ', Narberth' }, (results, status) => {
        let marker;
        if (status === 'OK' && results[0]) {
          marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location,
            title: statusData.location,
            icon: getMarkerIcon(statusData)
          });
        } else {
          marker = new google.maps.Marker({
            map: map,
            position: NARBERTH_CENTER,
            title: statusData.location,
            icon: getMarkerIcon(statusData)
          });
        }
        const infoWindow = new google.maps.InfoWindow({
          content: createMarkerContent(statusData)
        });
        marker.addListener('click', () => {
          infoWindow.open(map, marker);
        });
        markers.push({ id: statusId, marker: marker });
      });
    }

    function getMarkerIcon(statusData) {
      const baseIcon = {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: statusData.status === 'Walking' ? '#4CAF50' : statusData.status === 'Planning to walk' ? '#FFC107' : '#F44336',
        fillOpacity: 0.9,
        scale: 8,
        strokeColor: 'white',
        strokeWeight: 2
      };
      return baseIcon;
    }

    function createMarkerContent(statusData) {
      return `
        <div style="padding: 10px; max-width: 200px;">
          <h3 style="margin: 0 0 5px 0; color: ${statusData.status === 'Walking' ? '#4CAF50' : statusData.status === 'Planning to walk' ? '#FFC107' : '#F44336'}">
            ${statusData.status}
          </h3>
          <p style="margin: 0 0 5px 0;"><strong>Location:</strong> ${statusData.location}</p>
          <p style="margin: 0 0 5px 0;"><strong>Time:</strong> ${statusData.time}</p>
          <p style="margin: 0 0 5px 0;"><strong>Dog:</strong> ${statusData.dogStatus}</p>
          <p style="margin: 0;"><strong>Safety:</strong> <span class="${getSafetyClass(statusData.safety)}">${statusData.safety}</span></p>
        </div>
      `;
    }

    function addExistingMarkers() {
      if (!map) return;
      markers.forEach(m => m.marker.setMap(null));
      markers = [];
      document.querySelectorAll('.status').forEach(statusEl => {
        const statusId = statusEl.dataset.id;
        const statusData = JSON.parse(statusEl.dataset.status);
        addMarker(statusData, statusId);
      });
    }

    function checkGeolocation() {
      if (navigator.geolocation) {
        document.getElementById('location').addEventListener('focus', suggestCurrentLocation);
      }
    }

    function suggestCurrentLocation() {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          if (!geocoder) return;
          const userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
          if (getDistanceFromNarberth(userLocation) < 20) {
            geocoder.geocode({ location: userLocation }, (results, status) => {
              if (status === 'OK' && results[0]) {
                const address = results[0].formatted_address;
                const simplifiedAddress = address.replace(/, UK$/, '').replace(/Narberth, Pembrokeshire/i, 'Narberth');
                locationInput.placeholder = `Near ${simplifiedAddress}`;
              }
            });
          }
        },
        (error) => {
          console.log('Geolocation error:', error);
        },
        { timeout: 10000, enableHighAccuracy: true }
      );
    }

    function getSafetyClass(safetyStatus) {
      switch(safetyStatus.toLowerCase()) {
        case 'safe': return 'safety-safe';
        case 'unsafe': return 'safety-unsafe';
        case 'busy': return 'safety-unknown';
        default: return 'safety-unknown';
      }
    }

    function getStatusIcon(status) {
      switch(status.toLowerCase()) {
        case 'walking': return 'fas fa-walking';
        case 'not walking': return 'fas fa-home';
        case 'planning to walk': return 'fas fa-clock';
        default: return 'fas fa-paw';
      }
    }

    function formatTimeAgo(timestamp) {
      const now = new Date();
      const seconds = Math.floor((now - timestamp) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
      return `${Math.floor(seconds / 86400)} days ago`;
    }

    function createStatusElement(statusData, statusId) {
      const statusDiv = document.createElement('div');
      statusDiv.className = `status ${statusData.status.toLowerCase().replace(/ /g, '-')}`;
      statusDiv.dataset.id = statusId;
      statusDiv.dataset.status = JSON.stringify(statusData);
      const timeAgo = statusData.timestamp ? formatTimeAgo(new Date(statusData.timestamp)) : 'Recently';
      let notesContent = '';
      if (statusData.notes) {
        notesContent = `<p><strong><i class="fas fa-sticky-note status-icon"></i>Notes:</strong> ${statusData.notes}</p>`;
      }
      statusDiv.innerHTML = ` 
        <span class="time-ago">${timeAgo}</span>
        <p><strong><i class="${getStatusIcon(statusData.status)} status-icon"></i>Status:</strong> ${statusData.status}</p>
        <p><strong><i class="fas fa-map-marker-alt status-icon"></i>Location:</strong> ${statusData.location}</p>
        <p><strong><i class="far fa-clock status-icon"></i>Time:</strong> ${statusData.time}</p>
        <p><strong><i class="fas fa-dog status-icon"></i>Dog:</strong> ${statusData.dogStatus}</p>
        <p><strong><i class="fas fa-shield-alt status-icon"></i>Safety:</strong> <span class="${getSafetyClass(statusData.safety)}">${statusData.safety}</span></p>
        ${notesContent}
      `;
      return statusDiv;
    }

    function filterStatuses() {
      const statuses = document.querySelectorAll('.status');
      let visibleCount = 0;
      const now = Date.now();
      const oneDayInMillis = 24 * 60 * 60 * 1000;
      const cutoffTime = now - oneDayInMillis;
      statuses.forEach(status => {
        const statusData = JSON.parse(status.dataset.status);
        let shouldShow = false;
        if (statusData.timestamp >= cutoffTime) {
          switch(currentFilter) {
            case 'all':
              shouldShow = true;
              break;
            case 'walking':
              shouldShow = statusData.status === 'Walking';
              break;
            case 'not-walking':
              shouldShow = statusData.status === 'Not Walking';
              break;
            case 'planning':
              shouldShow = statusData.status === 'Planning to walk';
              break;
            case 'friendly':
              shouldShow = statusData.dogStatus.toLowerCase().includes('friendly');
              break;
            case 'service':
              shouldShow = statusData.dogStatus.toLowerCase().includes('service');
              break;
            default:
              shouldShow = true;
          }
        }
        if (shouldShow) {
          status.style.display = 'block';
          visibleCount++;
        } else {
          status.style.display = 'none';
        }
      });
      if (visibleCount === 0) {
        emptyStateEl.classList.remove('hidden');
      } else {
        emptyStateEl.classList.add('hidden');
      }
    }

    async function handleFormSubmit(e) {
      e.preventDefault();
      const submitButton = e.target.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      document.getElementById('loadingSpinner').style.display = 'block';
      try {
        const walkingStatus = document.getElementById('walkingStatus').value;
        const location = document.getElementById('location').value.trim();
        const walkTime = document.getElementById('walkTime').value;
        const dogStatus = document.getElementById('dogStatus').value;
        const safetyStatus = document.getElementById('safetyOptions').value;
        const otherNotes = document.getElementById('otherNotes').value.trim();
        if (!location || !walkTime || !dogStatus || !safetyStatus) {
          throw new Error('Please fill in all required fields');
        }
        const statusData = {
          status: walkingStatus === 'yes' ? 'Walking' : walkingStatus === 'no' ? 'Not Walking' : 'Planning to walk',
          location: location,
          time: walkTime,
          dogStatus: dogStatus,
          safety: safetyStatus,
          timestamp: Date.now()
        };
        if (otherNotes) statusData.notes = otherNotes;
        await push(statusListRef, statusData);
        showNotification('Status submitted successfully!');
        walkForm.reset();
        mapSelectionContainer.style.display = 'none';
      } catch (error) {
        console.error('Error submitting status:', error);
        showNotification(error.message || 'Error submitting status. Please try again.', true);
      } finally {
        submitButton.disabled = false;
        document.getElementById('loadingSpinner').style.display = 'none';
      }
    }

    // Listen for new status additions
    onChildAdded(statusListRef, (snapshot) => {
      const statusData = snapshot.val();
      const statusId = snapshot.key;
      const statusDiv = createStatusElement(statusData, statusId);
      statusDiv.style.animation = 'fadeIn 0.5s ease-out forwards';
      statusDiv.addEventListener('animationend', () => {
        statusDiv.style.animation = '';
      });
      statusListEl.insertBefore(statusDiv, statusListEl.firstChild);
      if (map) addMarker(statusData, statusId);
      filterStatuses();
    });

    // Listen for status removals
    onChildRemoved(statusListRef, (snapshot) => {
      const statusId = snapshot.key;
      const statusEl = document.querySelector(`.status[data-id="${statusId}"]`);
      if (statusEl) statusEl.remove();
      const markerIndex = markers.findIndex(m => m.id === statusId);
      if (markerIndex !== -1) {
        markers[markerIndex].marker.setMap(null);
        markers.splice(markerIndex, 1);
      }
      filterStatuses();
    });

    // Animate on scroll
    function animateOnScroll() {
      if (isThrottled) return;
      isThrottled = true;
      setTimeout(() => {
        const elements = document.querySelectorAll('.status, form, h1, h2');
        elements.forEach(element => {
          const elementPosition = element.getBoundingClientRect().top;
          const screenPosition = window.innerHeight / 1.2;
          if (elementPosition < screenPosition) {
            element.style.animation = 'fadeIn 0.6s ease-out forwards';
          }
        });
        isThrottled = false;
      }, 200);
    }
    window.addEventListener('scroll', animateOnScroll);
    animateOnScroll();

    // Flash modal logic
    document.getElementById('flashModalOk').addEventListener('click', () => {
      document.getElementById('flashModal').style.display = 'none';
    });
    document.getElementById('flashModalScroll').addEventListener('scroll', function () {
      const { scrollTop, scrollHeight, clientHeight } = this;
      if (scrollTop + clientHeight >= scrollHeight - 2) {
        document.getElementById('flashModalOk').disabled = false;
      }
    });
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('flashModal').style.display = 'flex';
    });
  </script>
</body>
</html>